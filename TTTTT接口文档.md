# TiTiTaTaToe2.0 接口文档

本文档说明 TTTTT 中所有 WebSocket、HTTP 报文格式。



## 典型流程

以下分析一次完整的从连接到对局结束的典型流程。

1. P1 建立与服务器的 WS 连接，输入并发送自己本次连接的用户名。
2. P1 通过 WS 连接获得当前用户列表（实时更新）。此时可以邀请一名用户进行对局，或者等待其他用户向自己发出对局请求。
3. P2 接受邀请，产生 P1、P2，开始游戏。
4. 服务端返回棋盘信息、对局情况、走子限制等等。
5. P1/P2 操作。
6. 重复 3-4，直至：
   1. P1/P2 操作超时：断开双方连接，返回相关信息。
   2. P1/P2 断开连接：断开另一方的连接，返回相关信息。
   3. 无效的走法：返回走法提示信息。
   4. P1/P2 胜利：断开双方连接，返回胜利信息。



## WebSocket 接口

### 服务端向客户端

将传递的信息头两位 byte 作为标识符位：

1. 第一位表明信息类型序号
2. 第二位表明操作是否成功
3. 其余位表明相应信息

系统中通过 WebSocket 传递的信息分为：服务端向客户端、客户端向服务端两种情况。以下依次分析。

注：斜体信息表示两个连接发送信息不同，或只向一个连接发送。其他信息同时向两个连接发送相同内容。

| 信息         | 信息类型序号（标识符1） | 操作是否成功（标识符2） | 其余信息                                                     |
| ------------ | ----------------------- | ----------------------- | ------------------------------------------------------------ |
| *连接成功*   | 1                       | 1                       | /                                                            |
| *游戏开始*   | 2                       | 1                       | 第一位：0/1 - 你是 P1 还是 P2                                |
| 落子成功     | 3                       | 1                       | 第一位：0/1 - 哪位用户（P1/P2）进行下一次操作，<br />第二位：[9,3,3] 数组 - 大棋盘，<br />第三位：0-8 - 下一个操作的小棋盘，<br />第四位：0/1/2/3 - 没有结束/P1胜利/P2胜利/平局（前三种情况关闭双方的连接）<br /> |
| *落子失败*   | 3                       | 0                       | 第一位：失败信息                                             |
| 连接中断     | 4                       | 0                       | 第一位：0/1 - 是 P1 还是 P2，<br />第二位：中断信息（超时或连接中断） |
| *邀请成功*   | *5*                     | *1*                     | *第一位：String - 对方用户名*                                |
| *邀请失败*   | *5*                     | *0*                     | *第一位：String - 对方用户名*                                |
| *发送邀请*   | *6*                     | *1*                     | *第一位：String - 邀请方用户名*                              |
| 用户列表     | 7                       | 1                       | [String] - 用户名列表，用`,`分割<br />注：向所有连接发送     |
| 处理邀请成功 | 8                       | 1                       | 第一位：0/1 - 接受或拒绝邀请<br />第二位：String - 邀请方用户名 |
| 处理邀请失败 | 8                       | 0                       | 第一位：0/1 - 接受或拒绝邀请<br />第二位：String - 邀请方用户名 |

### 客户端向服务端

| 信息         | 信息类型序号（标识符1） | 其余信息                                                  |
| ------------ | ----------------------- | --------------------------------------------------------- |
| 落子         | 1                       | 第一位：(0-8,0-2,0-2) - 落子坐标                          |
| 申请用户列表 | 2                       | /                                                         |
| 邀请用户     | 3                       | 第一位：String - 用户名                                   |
| 处理邀请     | 4                       | 第一位：0/1 - 是否接受<br />第二位：String - 邀请方用户名 |



## HTTP 接口

| 信息       | 类型 | URL       | 参数             | 响应              |
| ---------- | ---- | --------- | ---------------- | ----------------- |
| 申请用户名 | PUT  | /username | username: String | 是否成功: boolean |
| 获得用户名 | GET  | /username | /                | username: String  |

